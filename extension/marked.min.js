// Simple Markdown Parser for UTC Chat Assistant
// This is a lightweight markdown parser that handles the most common markdown features

function parseMarkdown(text) {
    if (!text) return '';
    
    let html = text;
    
    // Headers
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // Bold and italic
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Code blocks
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // Lists
    html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
    html = html.replace(/^- (.*$)/gim, '<li>$1</li>');
    html = html.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
    
    // Wrap consecutive list items in ul/ol
    html = html.replace(/(<li>.*<\/li>)/gs, function(match) {
        const items = match.match(/<li>.*?<\/li>/g);
        if (items && items.length > 0) {
            return '<ul>' + items.join('') + '</ul>';
        }
        return match;
    });
    
    // Blockquotes
    html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
    
    // Horizontal rules
    html = html.replace(/^---$/gim, '<hr>');
    html = html.replace(/^\*\*\*$/gim, '<hr>');
    
    // Tables (basic support)
    html = html.replace(/\|(.+)\|/g, function(match, content) {
        const cells = content.split('|').map(cell => cell.trim()).filter(cell => cell);
        if (cells.length > 0) {
            const cellTags = cells.map(cell => `<td>${cell}</td>`).join('');
            return `<tr>${cellTags}</tr>`;
        }
        return match;
    });
    
    // Wrap table rows in table
    html = html.replace(/(<tr>.*<\/tr>)/gs, function(match) {
        const rows = match.match(/<tr>.*?<\/tr>/g);
        if (rows && rows.length > 0) {
            return '<table>' + rows.join('') + '</table>';
        }
        return match;
    });
    
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    
    return html;
}

// Make it available globally
if (typeof window !== 'undefined') {
    window.marked = {
        parse: parseMarkdown
    };
}

// Export for Node.js if needed
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { parse: parseMarkdown };
}
